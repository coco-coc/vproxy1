name: Auto Sync Fork with Releases

on:
  schedule:
    - cron: '0 17 * * *'  # æ¯å¤© UTC 17 ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ æ£€å‡ºä½ çš„ fork ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false # ä¸æŒä¹…åŒ–é»˜è®¤å‡­è¯ï¼Œåç»­ä½¿ç”¨PAT
          fetch-depth: 0

      # 2ï¸âƒ£ å®‰è£…å¿…è¦å·¥å…·
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          # å®‰è£… GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      # 3ï¸âƒ£ é…ç½® Git
      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 4ï¸âƒ£ è·å–é»˜è®¤åˆ†æ”¯
      - name: Get default branch
        id: get_default_branch
        run: |
          default_branch=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
          echo "Default branch: $default_branch"
          echo "default_branch=$default_branch" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ å¤‡ä»½å·¥ä½œæµæ–‡ä»¶
      - name: Backup workflow files
        run: |
          mkdir -p /tmp/backup
          # åªå¤‡ä»½åŒæ­¥å·¥ä½œæµæœ¬èº«
          if [ -f ".github/workflows/sync.yml" ]; then
            cp .github/workflows/sync.yml /tmp/backup/
            echo "Backed up sync workflow"
          else
            echo "No sync workflow found to backup"
          fi

      # 6ï¸âƒ£ åˆ é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´é—®é¢˜çš„å·¥ä½œæµæ–‡ä»¶
      - name: Remove problematic workflow files
        run: |
          # åˆ é™¤æ‰€æœ‰å¯èƒ½è§¦å‘æ„å»ºçš„å·¥ä½œæµæ–‡ä»¶
          rm -f .github/workflows/build.yml 2>/dev/null || true
          rm -f .github/workflows/android.yml 2>/dev/null || true
          rm -f .github/workflows/ci.yml 2>/dev/null || true
          rm -f .github/workflows/release.yml 2>/dev/null || true
          echo "Removed problematic workflow files"
          
          # åˆ é™¤ Android ç­¾åé…ç½®æ–‡ä»¶
          rm -f android/key.properties 2>/dev/null || true
          rm -f android/app/android_keystore.jks 2>/dev/null || true
          # åˆ é™¤å¯èƒ½å¼•ç”¨è¿™äº›æ–‡ä»¶çš„ Gradle é…ç½®
          sed -i '/android_keystore/d' android/app/build.gradle 2>/dev/null || true
          echo "Removed Android config files"

      # 7ï¸âƒ£ æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æ‰€æœ‰å†…å®¹
      - name: Add upstream and fetch
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/5VNetwork/vproxy.git
          git fetch upstream --tags --force --prune
          git fetch upstream --force --prune '+refs/heads/*:refs/remotes/upstream/*'

      # 8ï¸âƒ£ åŒæ­¥æ‰€æœ‰åˆ†æ”¯ï¼ˆä¿ç•™å·¥ä½œæµæ–‡ä»¶ï¼‰
      - name: Sync branches with workflow preservation
        run: |
          # ä½¿ç”¨ä¹‹å‰è·å–çš„é»˜è®¤åˆ†æ”¯
          default_branch=${{ steps.get_default_branch.outputs.default_branch }}
          echo "Default branch: $default_branch"
          
          # è·å–ä¸Šæ¸¸æ‰€æœ‰åˆ†æ”¯
          git show-ref | grep 'refs/remotes/upstream/' | while read hash ref; do
            branch_name=${ref#refs/remotes/upstream/}
            
            # è·³è¿‡ HEAD å¼•ç”¨
            if [ "$branch_name" = "HEAD" ]; then
              continue
            fi
            
            echo "Processing branch: $branch_name"
            
            # åˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°åˆ†æ”¯
            if git show-ref --verify --quiet refs/heads/$branch_name; then
              echo "Updating existing branch: $branch_name"
              git checkout $branch_name
              
              # å¯¹äºé»˜è®¤åˆ†æ”¯ï¼Œä½¿ç”¨åˆå¹¶è€Œä¸æ˜¯é‡ç½®ï¼Œä»¥ä¿ç•™å·¥ä½œæµæ–‡ä»¶
              if [ "$branch_name" = "$default_branch" ]; then
                echo "Merging upstream changes to default branch (preserving workflows)"
                # å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  --allow-unrelated-histories é€‰é¡¹
                git merge --no-commit --allow-unrelated-histories upstream/$branch_name
                
                # æ¢å¤å·¥ä½œæµæ–‡ä»¶
                if [ -f "/tmp/backup/sync.yml" ]; then
                  mkdir -p .github/workflows
                  cp /tmp/backup/sync.yml .github/workflows/
                  git add .github/workflows/sync.yml
                fi
                
                # æäº¤åˆå¹¶
                if ! git diff --cached --quiet; then
                  git commit -m "Merge upstream changes and preserve workflows"
                fi
              else
                # å¯¹äºéé»˜è®¤åˆ†æ”¯ï¼Œä½¿ç”¨ç¡¬é‡ç½®
                git reset --hard upstream/$branch_name
              fi
            else
              echo "Creating new branch: $branch_name"
              git checkout -b $branch_name upstream/$branch_name
            fi
            
            # æ¨é€åˆ° origin - ä½¿ç”¨PATè®¤è¯ä¿¡æ¯
            echo "Pushing $branch_name to origin"
            git push https://${{ github.actor }}:${{ secrets.SYNC_PAT }}@github.com/${{ github.repository }}.git $branch_name --force
          done

      # 9ï¸âƒ£ åŒæ­¥æ‰€æœ‰æ ‡ç­¾ï¼ˆè·³è¿‡åŒ…å«å·¥ä½œæµæ–‡ä»¶çš„æ ‡ç­¾ï¼‰
      - name: Sync tags selectively
        run: |
          # åˆ é™¤æ‰€æœ‰æœ¬åœ°æ ‡ç­¾ï¼ˆé¿å…å†²çªï¼‰
          git tag -l | xargs git tag -d 2>/dev/null || true
          # è·å–ä¸Šæ¸¸æ‰€æœ‰æ ‡ç­¾
          git fetch upstream --tags --force
          
          # è·å–æ‰€æœ‰æ ‡ç­¾
          git tag -l | while read tag; do
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦åŒ…å«å·¥ä½œæµæ–‡ä»¶
            if git ls-tree -r $tag | grep -q ".github/workflows/"; then
              echo "Skipping tag $tag (contains workflow files)"
            else
              echo "Pushing tag $tag"
              git push https://${{ github.actor }}:${{ secrets.SYNC_PAT }}@github.com/${{ github.repository }}.git $tag --force || echo "Failed to push tag $tag"
            fi
          done

      # ğŸ”Ÿ è·å–ä¸Šæ¸¸å‘å¸ƒåˆ—è¡¨å’Œæœ¬åœ°å‘å¸ƒåˆ—è¡¨ï¼Œå¹¶æ£€æµ‹éœ€è¦åŒæ­¥çš„å‘å¸ƒ
      - name: Get release lists and detect changes
        id: get_releases
        env:
          SYNC_PAT: ${{ secrets.SYNC_PAT }} # ä½¿ç”¨PATæ›¿ä»£GITHUB_TOKEN
        run: |
          # è·å–ä¸Šæ¸¸æ‰€æœ‰å‘å¸ƒï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰
          echo "Getting upstream releases..."
          upstream_releases_json=$(curl -s -H "Authorization: token $SYNC_PAT" \
            "https://api.github.com/repos/5VNetwork/vproxy/releases?per_page=100")
          
          # è·å–æœ¬åœ°æ‰€æœ‰å‘å¸ƒï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰
          echo "Getting local releases..."
          local_releases_json=$(curl -s -H "Authorization: token $SYNC_PAT" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100")
          
          # æ‰¾å‡ºéœ€è¦åŒæ­¥çš„æ–°å‘å¸ƒæˆ–éœ€è¦æ›´æ–°çš„å‘å¸ƒ
          releases_to_sync=""
          
          # å¤„ç†æ¯ä¸ªä¸Šæ¸¸å‘å¸ƒ
          echo "$upstream_releases_json" | jq -r '.[] | @base64' | while read -r release; do
            _jq() {
              echo "${release}" | base64 --decode | jq -r "${1}"
            }
            
            tag_name=$(_jq '.tag_name')
            prerelease=$(_jq '.prerelease')
            draft=$(_jq '.draft')
            assets_count=$(_jq '.assets | length')
            published_at=$(_jq '.published_at')
            body=$(echo "${release}" | base64 --decode | jq -r '.body')
            
            echo "Checking upstream release: $tag_name (prerelease: $prerelease, draft: $draft)"
            
            # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥å‘å¸ƒ
            local_release=$(echo "$local_releases_json" | jq --arg tag "$tag_name" '.[] | select(.tag_name == $tag)')
            
            if [ -z "$local_release" ]; then
              # æ–°å‘å¸ƒï¼Œéœ€è¦åŒæ­¥
              echo "New release to sync: $tag_name"
              echo "$tag_name:new" >> /tmp/releases_to_sync
            else
              # å·²æœ‰å‘å¸ƒï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
              local_prerelease=$(echo "$local_release" | jq -r '.prerelease')
              local_draft=$(echo "$local_release" | jq -r '.draft')
              local_assets_count=$(echo "$local_release" | jq -r '.assets | length')
              local_published_at=$(echo "$local_release" | jq -r '.published_at')
              local_body=$(echo "$local_release" | jq -r '.body')
              
              echo "Local release: $tag_name (prerelease: $local_prerelease, draft: $local_draft)"
              
              # æ£€æŸ¥å‘å¸ƒçŠ¶æ€æ˜¯å¦æœ‰å˜æ›´ï¼ˆä»é¢„å‘å¸ƒå˜ä¸ºæ­£å¼å‘å¸ƒï¼Œæˆ–ä»è‰ç¨¿å˜ä¸ºå‘å¸ƒï¼‰
              if [ "$prerelease" != "$local_prerelease" ]; then
                echo "Release prerelease status changed for $tag_name: upstream=$prerelease, local=$local_prerelease"
                echo "$tag_name:update_prerelease" >> /tmp/releases_to_sync
              elif [ "$draft" != "$local_draft" ]; then
                echo "Release draft status changed for $tag_name: upstream=$draft, local=$local_draft"
                echo "$tag_name:update_draft" >> /tmp/releases_to_sync
              # æ£€æŸ¥èµ„äº§æ–‡ä»¶æ•°é‡æ˜¯å¦æœ‰å˜æ›´
              elif [ "$assets_count" != "$local_assets_count" ]; then
                echo "Release assets count changed for $tag_name: $assets_count vs $local_assets_count"
                echo "$tag_name:update_assets" >> /tmp/releases_to_sync
              # æ£€æŸ¥å‘å¸ƒæ—¶é—´æ˜¯å¦æœ‰å˜æ›´ï¼ˆå¯èƒ½æ˜¯é‡æ–°å‘å¸ƒï¼‰
              elif [ "$published_at" != "$local_published_at" ]; then
                echo "Release publish time changed for $tag_name: $published_at vs $local_published_at"
                echo "$tag_name:update_all" >> /tmp/releases_to_sync
              # æ£€æŸ¥å‘å¸ƒå†…å®¹æ˜¯å¦æœ‰å˜æ›´
              elif [ "$body" != "$local_body" ]; then
                echo "Release body changed for $tag_name"
                echo "$tag_name:update_body" >> /tmp/releases_to_sync
              fi
            fi
          done
          
          # å°†ç»“æœè®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          if [ -f /tmp/releases_to_sync ]; then
            releases_to_sync=$(cat /tmp/releases_to_sync | tr '\n' ' ')
            echo "Releases to sync: $releases_to_sync"
            echo "releases_to_sync=$releases_to_sync" >> $GITHUB_OUTPUT
          else
            echo "No releases to sync"
            echo "releases_to_sync=" >> $GITHUB_OUTPUT
          fi

      # 1ï¸âƒ£1ï¸âƒ£ ä¸‹è½½éœ€è¦åŒæ­¥çš„å‘å¸ƒèµ„æº
      - name: Download release assets
        if: steps.get_releases.outputs.releases_to_sync != ''
        run: |
          mkdir -p releases
          releases_to_sync="${{ steps.get_releases.outputs.releases_to_sync }}"
          
          echo "Releases to process: $releases_to_sync"
          
          # å¾ªç¯å¤„ç†æ¯ä¸ªéœ€è¦åŒæ­¥çš„å‘å¸ƒ
          for release_info in $releases_to_sync; do
            tag_name=$(echo "$release_info" | cut -d':' -f1)
            action=$(echo "$release_info" | cut -d':' -f2)
            echo "Processing release: $tag_name (action: $action)"
            
            # è·å–å‘å¸ƒè¯¦æƒ…
            release_info_json=$(curl -s -H "Authorization: token ${{ secrets.SYNC_PAT }}" \
              "https://api.github.com/repos/5VNetwork/vproxy/releases/tags/$tag_name")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if echo "$release_info_json" | jq -e '.message' > /dev/null 2>&1; then
              echo "Error getting release $tag_name: $(echo "$release_info_json" | jq -r '.message')"
              continue
            fi
            
            release_id=$(echo "$release_info_json" | jq -r '.id')
            created_at=$(echo "$release_info_json" | jq -r '.created_at')
            echo "Release ID: $release_id, Created at: $created_at"
            
            # ä¸ºæ¯ä¸ªæ ‡ç­¾åˆ›å»ºå­ç›®å½•
            mkdir -p "releases/$tag_name"
            
            # ä¿å­˜å‘å¸ƒä¿¡æ¯åˆ°æ–‡ä»¶ï¼ˆåŒ…æ‹¬åˆ›å»ºæ—¶é—´ï¼‰
            echo "$release_info_json" > "releases/$tag_name/release_info.json"
            
            # ä¸‹è½½æ¯ä¸ªèµ„æº
            assets=$(echo "$release_info_json" | jq -r '.assets | length')
            echo "Found $assets assets for $tag_name"
            
            if [ "$assets" -gt 0 ]; then
              for i in $(seq 0 $(($assets-1))); do
                asset_name=$(echo "$release_info_json" | jq -r ".assets[$i].name")
                download_url=$(echo "$release_info_json" | jq -r ".assets[$i].browser_download_url")
                
                echo "Downloading asset: $asset_name"
                curl -L -o "releases/$tag_name/$asset_name" "$download_url" || echo "Failed to download $asset_name"
              done
            else
              echo "No assets found for $tag_name"
            fi
            
            # æ·»åŠ å»¶è¿Ÿä»¥é¿å…é€Ÿç‡é™åˆ¶
            sleep 2
          done

      # 1ï¸âƒ£2ï¸âƒ£ ç¡®ä¿æ ‡ç­¾åœ¨æœ¬åœ°å­˜åœ¨
      - name: Ensure tags exist locally
        if: steps.get_releases.outputs.releases_to_sync != ''
        run: |
          releases_to_sync="${{ steps.get_releases.outputs.releases_to_sync }}"
          
          # è·å–æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ ‡ç­¾
          for release_info in $releases_to_sync; do
            tag_name=$(echo "$release_info" | cut -d':' -f1)
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦åœ¨æœ¬åœ°å­˜åœ¨
            if ! git show-ref --tags | grep -q "refs/tags/$tag_name"; then
              echo "Tag $tag_name does not exist locally, fetching from upstream..."
              # ä»ä¸Šæ¸¸è·å–ç‰¹å®šæ ‡ç­¾
              git fetch upstream tag $tag_name
              # å°†æ ‡ç­¾æ¨é€åˆ°origin
              git push https://${{ github.actor }}:${{ secrets.SYNC_PAT }}@github.com/${{ github.repository }}.git $tag_name --force
            else
              echo "Tag $tag_name exists locally"
            fi
          done

      # 1ï¸âƒ£3ï¸âƒ£ æŒ‰ç…§ä¸Šæ¸¸åˆ›å»ºæ—¶é—´é¡ºåºåˆ›å»ºæˆ–æ›´æ–° GitHub Releases
      - name: Create or update GitHub Releases in order
        if: steps.get_releases.outputs.releases_to_sync != ''
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }} # ä½¿ç”¨PATæ›¿ä»£GITHUB_TOKEN
        run: |
          # è·å–é»˜è®¤åˆ†æ”¯
          default_branch=${{ steps.get_default_branch.outputs.default_branch }}
          echo "Default branch: $default_branch"
          
          releases_to_sync="${{ steps.get_releases.outputs.releases_to_sync }}"
          
          # é¦–å…ˆï¼Œæ”¶é›†æ‰€æœ‰éœ€è¦åˆ›å»ºçš„å‘å¸ƒçš„ä¿¡æ¯ï¼ˆæ ‡ç­¾åã€åˆ›å»ºæ—¶é—´å’Œæ“ä½œç±»å‹ï¼‰
          declare -A release_dates
          declare -A release_actions
          for release_info in $releases_to_sync; do
            tag_name=$(echo "$release_info" | cut -d':' -f1)
            action=$(echo "$release_info" | cut -d':' -f2)
            tag_dir="releases/$tag_name"
            release_info_file="$tag_dir/release_info.json"
            
            if [ -f "$release_info_file" ]; then
              created_at=$(jq -r '.created_at' "$release_info_file")
              # å°†æ—¥æœŸè½¬æ¢ä¸ºæ—¶é—´æˆ³ä»¥ä¾¿æ’åº
              timestamp=$(date -d "$created_at" +%s)
              release_dates[$tag_name]=$timestamp
              release_actions[$tag_name]=$action
            else
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å‘å¸ƒä¿¡æ¯æ–‡ä»¶ï¼Œä½¿ç”¨å½“å‰æ—¶é—´æˆ³
              release_dates[$tag_name]=$(date +%s)
              release_actions[$tag_name]=$action
            fi
          done

          # æŒ‰ç…§æ—¶é—´æˆ³æ’åºæ ‡ç­¾å
          # ç”±äº Bash å…³è”æ•°ç»„ä¸èƒ½ç›´æ¥æ’åºï¼Œæˆ‘ä»¬å°†æ ‡ç­¾åå’Œæ—¶é—´æˆ³æ”¾å…¥æ•°ç»„ç„¶åæ’åº
          # åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œå…ƒç´ æ ¼å¼ä¸ºï¼šæ—¶é—´æˆ³:æ ‡ç­¾å:æ“ä½œç±»å‹
          for tag_name in "${!release_dates[@]}"; do
            printf "%d:%s:%s\n" "${release_dates[$tag_name]}" "$tag_name" "${release_actions[$tag_name]}"
          done | sort -n | while IFS=: read -r timestamp tag_name action; do
            # ç°åœ¨æŒ‰ç…§æ’åºåçš„é¡ºåºå¤„ç†æ¯ä¸ªæ ‡ç­¾
            tag_dir="releases/$tag_name"
            
            if [ -d "$tag_dir" ]; then
              echo "Processing release: $tag_name (action: $action)"
              
              # è¯»å–å‘å¸ƒä¿¡æ¯
              release_info_file="$tag_dir/release_info.json"
              if [ -f "$release_info_file" ]; then
                release_name=$(jq -r '.name' "$release_info_file")
                release_notes=$(jq -r '.body' "$release_info_file")
                prerelease=$(jq -r '.prerelease' "$release_info_file")
                draft=$(jq -r '.draft' "$release_info_file")
                
                echo "Upstream release: $tag_name (prerelease: $prerelease, draft: $draft)"
                
                # æ”¶é›†æ‰€æœ‰èµ„äº§æ–‡ä»¶ï¼ˆæ’é™¤ release_info.jsonï¼‰
                asset_files=()
                for file in "$tag_dir"/*; do
                  if [[ "$file" != *"release_info.json" ]]; then
                    asset_files+=("$file")
                  fi
                done
                
                if [ "$action" = "new" ]; then
                  # åˆ›å»ºæ–°å‘å¸ƒ
                  echo "Creating new release: $tag_name"
                  
                  # è®¾ç½®å‘å¸ƒå‚æ•°
                  prerelease_flag=""
                  draft_flag=""
                  if [ "$prerelease" = "true" ]; then
                    prerelease_flag="--prerelease"
                  fi
                  if [ "$draft" = "true" ]; then
                    draft_flag="--draft"
                  fi
                  
                  # è·å–æ ‡ç­¾å¯¹åº”çš„æäº¤å“ˆå¸Œ
                  target_commitish=$(git rev-list -n 1 "$tag_name" 2>/dev/null || echo "")
                  if [ -z "$target_commitish" ]; then
                    echo "Warning: Could not find commit for tag $tag_name, using default branch: $default_branch"
                    target_commitish="$default_branch"
                  fi
                  
                  # åˆ›å»ºå‘å¸ƒ - ä½¿ç”¨åŠ¨æ€è·å–çš„é»˜è®¤åˆ†æ”¯
                  if [ -n "$release_name" ] && [ "$release_name" != "null" ]; then
                    gh release create --repo ${{ github.repository }} "$tag_name" \
                      --title "$release_name" \
                      --notes "$release_notes" \
                      $prerelease_flag \
                      $draft_flag \
                      --target "$target_commitish" || echo "Release $tag_name may already exist, will try to update"
                  else
                    gh release create --repo ${{ github.repository }} "$tag_name" \
                      --notes "$release_notes" \
                      $prerelease_flag \
                      $draft_flag \
                      --target "$target_commitish" || echo "Release $tag_name may already exist, will try to update"
                  fi
                  
                  # ä¸Šä¼ èµ„äº§æ–‡ä»¶
                  for asset_file in "${asset_files[@]}"; do
                    echo "Uploading asset: $asset_file"
                    gh release upload --repo ${{ github.repository }} "$tag_name" "$asset_file" || echo "Failed to upload $asset_file"
                    sleep 1  # é¿å…é€Ÿç‡é™åˆ¶
                  done
                else
                  # æ›´æ–°å·²æœ‰å‘å¸ƒ
                  echo "Updating existing release: $tag_name (action: $action)"
                  
                  # æ ¹æ®ä¸åŒçš„æ“ä½œç±»å‹æ‰§è¡Œä¸åŒçš„æ›´æ–°
                  case $action in
                    "update_prerelease")
                      echo "Updating prerelease status for $tag_name to: $prerelease"
                      # æ˜ç¡®è®¾ç½®é¢„å‘å¸ƒçŠ¶æ€
                      if [ "$prerelease" = "true" ]; then
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --prerelease || echo "Failed to set prerelease for $tag_name"
                      else
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --prerelease=false || echo "Failed to unset prerelease for $tag_name"
                      fi
                      ;;
                    "update_draft")
                      echo "Updating draft status for $tag_name to: $draft"
                      # æ˜ç¡®è®¾ç½®è‰ç¨¿çŠ¶æ€
                      if [ "$draft" = "true" ]; then
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --draft || echo "Failed to set draft for $tag_name"
                      else
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --draft=false || echo "Failed to unset draft for $tag_name"
                      fi
                      ;;
                    "update_body")
                      echo "Updating release body for $tag_name"
                      # åªæ›´æ–°å‘å¸ƒè¯´æ˜
                      gh release edit --repo ${{ github.repository }} "$tag_name" \
                        --notes "$release_notes" || echo "Failed to update release body for $tag_name"
                      ;;
                    "update_assets")
                      echo "Updating release assets for $tag_name"
                      # è·å–å½“å‰å‘å¸ƒçš„èµ„äº§æ–‡ä»¶åˆ—è¡¨
                      existing_assets=$(gh release view --repo ${{ github.repository }} "$tag_name" --json assets --jq '.assets[].name' 2>/dev/null || echo "")
                      
                      # åˆ é™¤æ—§çš„èµ„äº§æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                      if [ -n "$existing_assets" ]; then
                        echo "Deleting existing assets for $tag_name"
                        for asset in $existing_assets; do
                          gh release delete-asset --repo ${{ github.repository }} "$tag_name" "$asset" || echo "Failed to delete asset $asset"
                          sleep 1  # é¿å…é€Ÿç‡é™åˆ¶
                        done
                      fi
                      
                      # ä¸Šä¼ æ–°çš„èµ„äº§æ–‡ä»¶
                      for asset_file in "${asset_files[@]}"; do
                        echo "Uploading asset: $asset_file"
                        gh release upload --repo ${{ github.repository }} "$tag_name" "$asset_file" || echo "Failed to upload $asset_file"
                        sleep 1  # é¿å…é€Ÿç‡é™åˆ¶
                      done
                      ;;
                    "update_all")
                      echo "Updating all release properties for $tag_name"
                      # è·å–å½“å‰å‘å¸ƒçš„èµ„äº§æ–‡ä»¶åˆ—è¡¨
                      existing_assets=$(gh release view --repo ${{ github.repository }} "$tag_name" --json assets --jq '.assets[].name' 2>/dev/null || echo "")
                      
                      # åˆ é™¤æ—§çš„èµ„äº§æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                      if [ -n "$existing_assets" ]; then
                        echo "Deleting existing assets for $tag_name"
                        for asset in $existing_assets; do
                          gh release delete-asset --repo ${{ github.repository }} "$tag_name" "$asset" || echo "Failed to delete asset $asset"
                          sleep 1  # é¿å…é€Ÿç‡é™åˆ¶
                        done
                      fi
                      
                      # æ›´æ–°å‘å¸ƒä¿¡æ¯
                      gh release edit --repo ${{ github.repository }} "$tag_name" \
                        --title "$release_name" \
                        --notes "$release_notes" || echo "Failed to update release info for $tag_name"
                      
                      # æ˜ç¡®è®¾ç½®é¢„å‘å¸ƒçŠ¶æ€
                      if [ "$prerelease" = "true" ]; then
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --prerelease || echo "Failed to set prerelease for $tag_name"
                      else
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --prerelease=false || echo "Failed to unset prerelease for $tag_name"
                      fi
                      
                      # æ˜ç¡®è®¾ç½®è‰ç¨¿çŠ¶æ€
                      if [ "$draft" = "true" ]; then
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --draft || echo "Failed to set draft for $tag_name"
                      else
                        gh release edit --repo ${{ github.repository }} "$tag_name" \
                          --draft=false || echo "Failed to unset draft for $tag_name"
                      fi
                      
                      # ä¸Šä¼ æ–°çš„èµ„äº§æ–‡ä»¶
                      for asset_file in "${asset_files[@]}"; do
                        echo "Uploading asset: $asset_file"
                        gh release upload --repo ${{ github.repository }} "$tag_name" "$asset_file" || echo "Failed to upload $asset_file"
                        sleep 1  # é¿å…é€Ÿç‡é™åˆ¶
                      done
                      ;;
                  esac
                fi
                
                echo "Processed release: $tag_name"
              else
                echo "No release info found for $tag_name"
              fi
            else
              echo "No assets found for $tag_name"
            fi
            
            # æ·»åŠ å»¶è¿Ÿä»¥é¿å…é€Ÿç‡é™åˆ¶
            sleep 5
          done

      # 1ï¸âƒ£4ï¸âƒ£ æ¸…ç†ä¸‹è½½çš„èµ„æº
      - name: Clean up downloaded assets
        run: |
          rm -rf releases
          echo "Cleaned up downloaded assets"

      # 1ï¸âƒ£5ï¸âƒ£ å‘é€å®Œæˆé€šçŸ¥
      - name: Notify on completion
        run: |
          releases_to_sync="${{ steps.get_releases.outputs.releases_to_sync }}"
          if [ -n "$releases_to_sync" ]; then
            echo "Sync completed at $(date)"
            echo "Releases processed: $releases_to_sync"
          else
            echo "Sync completed at $(date)"
            echo "No releases to sync"
          fi
          echo "Repository: https://github.com/${{ github.repository }}"
